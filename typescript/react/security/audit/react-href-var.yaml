rules:
  - id: react-href-var
    message: >-
      Detected a variable used in an anchor tag with the 'href' attribute. A
      malicious actor may be able to input the 'javascript:' URI, which could
      cause cross-site scripting (XSS). It is recommended to disallow
      'javascript:' URIs within your application.
    metadata:
      cwe:
        - "CWE-79: Improper Neutralization of Input During Web Page Generation
          ('Cross-site Scripting')"
      owasp:
        - A07:2017 - Cross-Site Scripting (XSS)
        - A03:2021 - Injection
      references:
        - https://reactjs.org/blog/2019/08/08/react-v16.9.0.html#deprecating-javascript-urls
        - https://pragmaticwebsecurity.com/articles/spasecurity/react-xss-part1.html
      category: security
      confidence: LOW
      technology:
        - react
      license: Commons Clause License Condition v1.0[LGPL-2.1-only]
      cwe2022-top25: true
      cwe2021-top25: true
      subcategory:
        - audit
      likelihood: LOW
      impact: MEDIUM
    languages:
      - typescript
      - javascript
    severity: WARNING
    mode: taint
    pattern-sources:
      - label: TAINTED
        patterns:
          - pattern-either:
              - pattern-inside: |
                  function ...({..., $X, ...}) { ... }
              - pattern-inside: |
                  function ...(..., $X, ...) { ... }
          - focus-metavariable: $X
          - pattern-either:
              - pattern: $X.$Y
              - pattern: $X[...]
          # This removes function maps, which generally are from imported hardcoded values
          - pattern-not-inside: |
              $F. ... .$SANITIZEUNC(...)
      - label: CONCAT
        requires: TAINTED
        patterns:
          - pattern-either:
              - pattern: |
                  `...${$X}...`
              - pattern: |
                  $SANITIZE + <... $X ...>
          - pattern-not: |
              `${$X}...`
          - pattern-not: |
              $X + ...
          - focus-metavariable: $X
    pattern-sinks:
      - requires: TAINTED and not CONCAT
        patterns:
          - focus-metavariable: $X
          - pattern-either:
              - pattern: |
                  <$EL href={$X} />
              - pattern: |
                  React.createElement($EL, {href: $X})
              - pattern-inside: |
                  $PARAMS = {href: $X};
                  ...
                  React.createElement($EL, $PARAMS);
          # Removing any element which has buttons since it tends to be a fp
          - metavariable-pattern:
              patterns:
                - pattern-not-regex: (?i)(button)
              metavariable: $EL
    pattern-sanitizers:
      # Operators have been known to cause FPs, so removing any value which does not equal 
      - patterns:
          - pattern-either:
              - pattern: |
                  <... $A ...> ? $VAL1 : $VAL2
              - pattern: |
                  <... $A ...> ? $VAL2 : $VAL1
          - metavariable-pattern:
              patterns:
                - pattern: |
                    `${...}...`
                - pattern-not: |
                    "..."
                - pattern-not: |
                    "..." + $V
                - pattern-not: |
                    "..." + $V + ...
                - pattern-not: |
                    `...${...}...`
              metavariable: $VAL1
          - focus-metavariable: $VAL1
      - patterns:
          - pattern-either:
              - patterns:
                  - pattern-either:
                      - pattern: |
                          <... $A ...> ? $VAL1 : $VAL2
                      - pattern: |
                          <... $A ...> ? $VAL2 : $VAL1
                  - pattern: $VAL1
              - patterns:
                  - pattern-either:
                      - pattern-inside: |
                          if (<... !$A($SOURCE) ...>) { 
                              ... 
                          }
                          ...
                      - pattern-inside: |
                          if (<... !$SANITIZE. ... .$A($SOURCE) ...>) { 
                              ... 
                          } 
                          ...
                      - pattern-inside: |
                          if (<... !$A. ... .$SANITIZE($SOURCE) ...>) { 
                              ... 
                          } 
                          ...
                      - pattern-inside: |
                          if (<... $A. ... .$SANITIZE($SOURCE) ...>) { 
                              ... 
                          } 
                      - pattern-inside: |
                          if (<... $S. ... .$A($SOURCE) ...>) { 
                              ... 
                          } 
                      - pattern-inside: |
                          if (<... $A($SOURCE) ...>) { 
                              ... 
                          }
                      - pattern: $A($SOURCE)
                      - pattern: $SANITIZE. ... .$A($SOURCE)
                      - pattern: $A. ... .$SANITIZE($SOURCE)
                  - pattern: $SOURCE
          - metavariable-regex:
              metavariable: $A
              regex: (?i)(.*valid|.*sanitiz)
      - patterns:
          - pattern-inside: |
              if (<... $SOURCE.startsWith(...) ...>) { 
                  ... 
              }
          - pattern: $SOURCE
