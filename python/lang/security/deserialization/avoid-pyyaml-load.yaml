rules:
  - id: avoid-pyyaml-load
    metadata:
      owasp:
        - "A08:2017 - Insecure Deserialization"
        - "A03:2021 - Injection"
      cwe: "CWE-502: Deserialization of Untrusted Data"
      references:
        - https://github.com/yaml/pyyaml/wiki/PyYAML-yaml.load(input)-Deprecation
        - https://nvd.nist.gov/vuln/detail/CVE-2017-18342
      category: security
      technology:
        - pyyaml
    languages:
      - python
    message: >-
      Avoid using `load()`. `PyYAML.load` can create arbitrary Python
      objects. A malicious actor could exploit this to run arbitrary
      code. Use `safe_load()` instead.
    fix-regex:
      regex: load
      replacement: safe_load
      count: 1
    severity: ERROR
    patterns:
      - pattern-inside: |
          import yaml
          ...
      - pattern-not-inside: |
          $YAML = ruamel.yaml.YAML(...)
          ...
      - pattern-not: yaml.load(..., Loader=yaml.CSafeLoader, ...)
      - pattern-not: yaml.load(..., Loader=yaml.SafeLoader, ...)
      - pattern-not: yaml.load(..., Loader=yaml.BaseLoader, ...)
      - pattern-not: yaml.load_all(..., Loader=yaml.CSafeLoader, ...)
      - pattern-not: yaml.load_all(..., Loader=yaml.SafeLoader, ...)
      - pattern-not: yaml.load_all(..., Loader=yaml.BaseLoader, ...)
      - pattern-either:
          - pattern: yaml.unsafe_load(...)
          - pattern: yaml.load(..., Loader=yaml.Loader, ...)
          - pattern: yaml.load(..., Loader=yaml.UnsafeLoader, ...)
          - pattern: yaml.load(..., Loader=yaml.CLoader, ...)
          - pattern: yaml.load_all(..., Loader=yaml.Loader, ...)
          - pattern: yaml.load_all(..., Loader=yaml.UnsafeLoader, ...)
          - pattern: yaml.load_all(..., Loader=yaml.CLoader, ...)