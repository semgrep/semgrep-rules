rules:
  - id: res-render-injection
    message: >-
      If an attacker controls the x in res.render(x) then they can cause code to load that was not intended to run on the server.
    severity: WARNING
    languages: [javascript, typescript]
    metadata:
      owasp: "A1: Injection"
      cwe: "CWE-706: Use of Incorrectly-Resolved Name or Reference"
      category: security
      technology:
        - express
    mode: taint
    pattern-sources:
    - patterns:
        - pattern-either:
            - pattern-inside: function ... ($REQ, $RES) {...}
            - pattern-inside: function ... ($REQ, $RES, $NEXT) {...}
            - patterns:
                - pattern-either:
                    - pattern-inside: $APP.$METHOD(..., function $FUNC($REQ, $RES) {...})
                    - pattern-inside: $APP.$METHOD(..., function $FUNC($REQ, $RES, $NEXT) {...})
                - metavariable-regex:
                    metavariable: $METHOD
                    regex: ^(get|post|put|head|delete|options)$
        - pattern-either:
            - pattern: $REQ.query
            - pattern: $REQ.body
            - pattern: $REQ.params
            - pattern: $REQ.cookies
            - pattern: $REQ.headers
    - patterns:
        - pattern-either:
            - pattern-inside: >
                ({ $REQ }: Request,$RES: Response, $NEXT: NextFunction) =>
                {...}
            - pattern-inside: |
                ({ $REQ }: Request,$RES: Response) => {...}
        - focus-metavariable: $REQ
        - pattern-either:
            - pattern: params
            - pattern: query
            - pattern: cookies
            - pattern: headers
            - pattern: body
    pattern-sinks:
        - patterns:
            - pattern-either:
                - pattern: $RES.render($SINK, ...)
                - pattern: $RES.render($SINK, ...)
            - focus-metavariable: $SINK
