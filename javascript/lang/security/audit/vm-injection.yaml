rules:
- id: vm-runincontext-context-injection
  languages:
  - javascript
  - typescript
  message: "Make sure that unverified user data can not reach vm.runInContext.\n"
  metadata:
    cwe: 'CWE-94: Improper Control of Generation of Code (Code Injection)'
    owasp: 'A1: Injection'
  patterns:
  - pattern-inside: "...\n$VM = require('vm');\n...\n"
  - pattern-either:
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $CONTEXT = <... $INPUT ...>;\n  ...\n  $VM.runInContext($CODE,<... $CONTEXT\
        \ ...>,...);\n  ...\n}\n"
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $CONTEXT = {$NAME: <... $INPUT ...>};\n  ...\n  $VM.runInContext($CODE,<...\
        \ $CONTEXT ...>,...);\n  ...\n}\n"
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $CONTEXT = <... {$NAME:$INPUT} ...>;\n  ...\n  $VM.runInContext($CODE,<...\
        \ $CONTEXT ...>,...);\n  ...\n}\n"
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $VAR = <... $INPUT ...>;\n  ...\n  $CONTEXT = {$NAME: <... $VAR ...>};\n\
        \  ...\n  $VM.runInContext($CODE,<... $CONTEXT ...>,...);\n  ...\n}\n"
    - pattern: "function $FUNC(...,$INPUT,...) {\n  ...\n  $CONTEXT = <... $INPUT ...>;\n  ...\n  $VM.runInContext($CODE,<...\
        \ $CONTEXT ...>,...);\n  ...\n}\n"
    - pattern: "function $FUNC(...,$INPUT,...) {\n  ...\n  $CONTEXT = <... {$NAME:$INPUT} ...>;\n  ...\n  $VM.runInContext($CODE,<...\
        \ $CONTEXT ...>,...);\n  ...\n}\n"
    - pattern: "function $FUNC(...,$INPUT,...) {\n  ...\n  $CONTEXT = {$NAME: <... $INPUT ...>};\n  ...\n  $VM.runInContext($CODE,<...\
        \ $CONTEXT ...>,...);\n  ...\n}\n"
    - pattern: "function $FUNC(...,$INPUT,...) {\n  ...\n  $VAR = <... $INPUT ...>;\n  ...\n  $CONTEXT = {$NAME: <... $VAR\
        \ ...>};\n  ...\n  $VM.runInContext($CODE,<... $CONTEXT ...>,...);\n  ...\n}\n"
  severity: WARNING
- id: vm-runinnewcontext-context-injection
  languages:
  - javascript
  - typescript
  message: "Make sure that unverified user data can not reach vm.runInNewContext.\n"
  metadata:
    cwe: 'CWE-94: Improper Control of Generation of Code (Code Injection)'
    owasp: 'A1: Injection'
  patterns:
  - pattern-inside: "...\n$VM = require('vm');\n...\n"
  - pattern-either:
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $VM.runInNewContext($CODE,<... $INPUT ...>,...);\n  ...\n}\n"
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $CONTEXT = <... $INPUT ...>;\n  ...\n  $VM.runInNewContext($CODE,<...\
        \ $CONTEXT ...>,...);\n  ...\n}\n"
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $CONTEXT = {$NAME: <... $INPUT ...>};\n  ...\n  $VM.runInNewContext($CODE,<...\
        \ $CONTEXT ...>,...);\n  ...\n}\n"
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $CONTEXT = <... {$NAME:$INPUT} ...>;\n  ...\n  $VM.runInNewContext($CODE,<...\
        \ $CONTEXT ...>,...);\n  ...\n}\n"
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $VAR = <... $INPUT ...>;\n  ...\n  $CONTEXT = {$NAME: <... $VAR ...>};\n\
        \  ...\n  $VM.runInNewContext($CODE,<... $CONTEXT ...>,...);\n  ...\n}\n"
    - pattern: "function $FUNC(...,$INPUT,...) {\n  ...\n  $VM.runInNewContext($CODE,<... $INPUT ...>,...);\n  ...\n}\n"
    - pattern: "function $FUNC(...,$INPUT,...) {\n  ...\n  $CONTEXT = <... $INPUT ...>;\n  ...\n  $VM.runInNewContext($CODE,<...\
        \ $CONTEXT ...>,...);\n  ...\n}\n"
    - pattern: "function $FUNC(...,$INPUT,...) {\n  ...\n  $CONTEXT = <... {$NAME:$INPUT} ...>;\n  ...\n  $VM.runInNewContext($CODE,<...\
        \ $CONTEXT ...>,...);\n  ...\n}\n"
    - pattern: "function $FUNC(...,$INPUT,...) {\n  ...\n  $CONTEXT = {$NAME: <... $INPUT ...>};\n  ...\n  $VM.runInNewContext($CODE,<...\
        \ $CONTEXT ...>,...);\n  ...\n}\n"
    - pattern: "function $FUNC(...,$INPUT,...) {\n  ...\n  $VAR = <... $INPUT ...>;\n  ...\n  $CONTEXT = {$NAME: <... $VAR\
        \ ...>};\n  ...\n  $VM.runInNewContext($CODE,<... $CONTEXT ...>,...);\n  ...\n}\n"
  severity: WARNING
- id: vm-compilefunction-context-injection
  languages:
  - javascript
  - typescript
  message: "Make sure that unverified user data can not reach vm.compileFunction.\n"
  metadata:
    cwe: 'CWE-94: Improper Control of Generation of Code (Code Injection)'
    owasp: 'A1: Injection'
  patterns:
  - pattern-inside: "...\n$VM = require('vm');\n...\n"
  - pattern-either:
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $VM.compileFunction($CODE,$PARAMS,{parsingContext: <... $INPUT ...>},...);\n\
        \  ...\n}\n"
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $CONTEXT = <... $INPUT ...>;\n  ...\n  $VM.compileFunction($CODE,$PARAMS,{parsingContext:\
        \ <... $CONTEXT ...>},...);\n  ...\n}\n"
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $CONTEXT = <... {$NAME:$INPUT} ...>;\n  ...\n  $VM.compileFunction($CODE,$PARAMS,{parsingContext:\
        \ <... $CONTEXT ...>},...);\n  ...\n}\n"
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $CONTEXT = {$NAME: <... $INPUT ...>};\n  ...\n  $VM.compileFunction($CODE,$PARAMS,{parsingContext:\
        \ <... $CONTEXT ...>},...);\n  ...\n}\n"
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $VAR = <... $INPUT ...>;\n  ...\n  $CONTEXT = {$NAME: <... $VAR ...>};\n\
        \  ...\n  $VM.compileFunction($CODE,$PARAMS,{parsingContext: <... $CONTEXT ...>},...);\n  ...\n}\n"
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $OPTS = {parsingContext: <... $INPUT ...>};\n  ...\n  $VM.compileFunction($CODE,$PARAMS,$OPTS,...);\n\
        \  ...\n}\n"
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $CONTEXT = <... $INPUT ...>;\n  ...\n  $OPTS = {parsingContext: <...\
        \ $CONTEXT ...>};\n  ...\n  $VM.compileFunction($CODE,$PARAMS,$OPTS,...);\n  ...\n}\n"
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $CONTEXT = {$NAME: <... $INPUT ...>};\n  ...\n  $OPTS = {parsingContext:\
        \ <... $CONTEXT ...>};\n  ...\n  $VM.compileFunction($CODE,$PARAMS,$OPTS,...);\n  ...\n}\n"
    - pattern: "function (...,$INPUT,...) {\n  ...\n  $VAR = <... $INPUT ...>;\n  ...\n  $CONTEXT = {$NAME: <... $VAR ...>};\n\
        \  ...\n  $OPTS = {parsingContext: <... $CONTEXT ...>};\n  ...\n  $VM.compileFunction($CODE,$PARAMS,$OPTS,...);\n\
        \  ...\n}\n"
    - pattern: "function $F(...,$INPUT,...) {\n  ...\n  $VM.compileFunction($CODE,$PARAMS,{parsingContext: <... $INPUT ...>},...);\n\
        \  ...\n}\n"
    - pattern: "function $F(...,$INPUT,...) {\n  ...\n  $CONTEXT = <... $INPUT ...>;\n  ...\n  $VM.compileFunction($CODE,$PARAMS,{parsingContext:\
        \ <... $CONTEXT ...>},...);\n  ...\n}\n"
    - pattern: "function $F(...,$INPUT,...) {\n  ...\n  $CONTEXT = <... {$NAME:$INPUT} ...>;\n  ...\n  $VM.compileFunction($CODE,$PARAMS,{parsingContext:\
        \ <... $CONTEXT ...>},...);\n  ...\n}\n"
    - pattern: "function $F(...,$INPUT,...) {\n  ...\n  $CONTEXT = {$NAME: <... $INPUT ...>};\n  ...\n  $VM.compileFunction($CODE,$PARAMS,{parsingContext:\
        \ <... $CONTEXT ...>},...);\n  ...\n}\n"
    - pattern: "function $F(...,$INPUT,...) {\n  ...\n  $VAR = <... $INPUT ...>;\n  ...\n  $CONTEXT = {$NAME: <... $VAR ...>};\n\
        \  ...\n  $VM.compileFunction($CODE,$PARAMS,{parsingContext: <... $CONTEXT ...>},...);\n  ...\n}\n"
    - pattern: "function $F(...,$INPUT,...) {\n  ...\n  $OPTS = {parsingContext: <... $INPUT ...>};\n  ...\n  $VM.compileFunction($CODE,$PARAMS,$OPTS,...);\n\
        \  ...\n}\n"
    - pattern: "function $F(...,$INPUT,...) {\n  ...\n  $CONTEXT = <... $INPUT ...>;\n  ...\n  $OPTS = {parsingContext: <...\
        \ $CONTEXT ...>};\n  ...\n  $VM.compileFunction($CODE,$PARAMS,$OPTS,...);\n  ...\n}\n"
    - pattern: "function $F(...,$INPUT,...) {\n  ...\n  $CONTEXT = {$NAME: <... $INPUT ...>};\n  ...\n  $OPTS = {parsingContext:\
        \ <... $CONTEXT ...>};\n  ...\n  $VM.compileFunction($CODE,$PARAMS,$OPTS,...);\n  ...\n}\n"
    - pattern: "function $F(...,$INPUT,...) {\n  ...\n  $VAR = <... $INPUT ...>;\n  ...\n  $CONTEXT = {$NAME: <... $VAR ...>};\n\
        \  ...\n  $OPTS = {parsingContext: <... $CONTEXT ...>};\n  ...\n  $VM.compileFunction($CODE,$PARAMS,$OPTS,...);\n\
        \  ...\n}\n"
  severity: WARNING
- id: vm-script-code-injection
  languages:
  - javascript
  - typescript
  message: "Make sure that unverified user data can not reach vm.Script.\n"
  metadata:
    cwe: 'CWE-94: Improper Control of Generation of Code (Code Injection)'
    owasp: 'A1: Injection'
  patterns:
  - pattern-inside: "...\n$VM = require('vm');\n...\n"
  - pattern: new $VM.Script($CODE,...)
  - pattern-not-inside: new $VM.Script("...",...)
  - pattern-not-inside: "$CODE = \"...\";\n...\nnew $VM.Script($CODE,...);"
  severity: WARNING
- id: vm-runincontext-code-injection
  languages:
  - javascript
  - typescript
  message: "Make sure that unverified user data can not reach vm.runInContext.\n"
  metadata:
    cwe: 'CWE-94: Improper Control of Generation of Code (Code Injection)'
    owasp: 'A1: Injection'
  patterns:
  - pattern-inside: "...\n$VM = require('vm');\n...\n"
  - pattern: $VM.runInContext($CODE,...)
  - pattern-not-inside: $VM.runInContext("...",...)
  - pattern-not-inside: "$CODE = \"...\";\n...\n$VM.runInContext($CODE,...);\n"
  severity: WARNING
- id: vm-runinnewcontext-code-injection
  languages:
  - javascript
  - typescript
  message: "Make sure that unverified user data can not reach vm.runInNewContext.\n"
  metadata:
    cwe: 'CWE-94: Improper Control of Generation of Code (Code Injection)'
    owasp: 'A1: Injection'
  patterns:
  - pattern-inside: "...\n$VM = require('vm');\n...\n"
  - pattern: $VM.runInNewContext($CODE,...)
  - pattern-not-inside: $VM.runInNewContext("...",...)
  - pattern-not-inside: "$CODE = \"...\";\n...\n$VM.runInNewContext($CODE,...);\n"
  severity: WARNING
- id: vm-runinthiscontext-code-injection
  languages:
  - javascript
  - typescript
  message: "Make sure that unverified user data can not reach vm.runInThisContext.\n"
  metadata:
    cwe: 'CWE-94: Improper Control of Generation of Code (Code Injection)'
    owasp: 'A1: Injection'
  patterns:
  - pattern-inside: "...\n$VM = require('vm');\n...\n"
  - pattern: $VM.runInThisContext($CODE,...)
  - pattern-not-inside: $VM.runInThisContext("...",...)
  - pattern-not-inside: "$CODE = \"...\";\n...\n$VM.runInThisContext($CODE,...);\n"
  severity: WARNING
- id: vm-compilefunction-code-injection
  languages:
  - javascript
  - typescript
  message: "Make sure that unverified user data can not reach vm.compileFunction.\n"
  metadata:
    cwe: 'CWE-94: Improper Control of Generation of Code (Code Injection)'
    owasp: 'A1: Injection'
  patterns:
  - pattern-inside: "...\n$VM = require('vm');\n...\n"
  - pattern: $VM.compileFunction($CODE,...)
  - pattern-not-inside: $VM.compileFunction("...",...)
  - pattern-not-inside: "$CODE = \"...\";\n...\n$VM.compileFunction($CODE,...);"
  severity: WARNING
