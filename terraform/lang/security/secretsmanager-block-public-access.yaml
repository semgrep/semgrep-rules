rules:
- id: secretsmanager-block-public-access
  patterns:
  - pattern: |
      resource
  - pattern-inside: |
      resource "aws_secretsmanager_secret_policy" "..." {
        ...
      }
  - pattern-not-inside: |
      resource "aws_secretsmanager_secret_policy" "..." {
        ...
        block_public_policy = true
        ...
      }
  languages:
  - hcl
  severity: WARNING
  message: >-
    SecretsManager secret policy without the 'block_public_policy' flag set. 
    Explicitly set this flag to 'true' to ensure your secret cannot become public by mistake.
  metadata:
    references:
    - https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/secretsmanager_secret_policy#block_public_policy
    - https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_PutResourcePolicy.html#API_PutResourcePolicy_RequestSyntax
    cwe: 'CWE-200: Exposure of Sensitive Information to an Unauthorized Actor'
    category: security
    technology:
    - terraform
    - aws
