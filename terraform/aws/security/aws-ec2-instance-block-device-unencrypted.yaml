rules:
- id: aws-ec2-instance-block-device-unencrypted
  pattern-either:
  - patterns:
    - pattern: |
        resource "aws_instance" $ANYTHING {
          ...
        }
    - pattern-not-inside: |
        resource "aws_instance" $ANYTHING {
          ...
          root_block_device {
            ...
            encrypted = true
            ...
          }
          ...
        }
  - patterns:
    - pattern-inside: |
        resource "aws_instance" $ANYTHING {
          ...
        }
    - pattern: |
        ebs_block_device {
          ...
        }
    - pattern-not: |
        ebs_block_device {
          ...
          encrypted = true
          ...
        }
  message: >-
    The AWS EC2 block device is unencrypted. The block device could be read
    if compromised. Block devices should be encrypted to ensure sensitive data is
    held securely at rest.
  languages:
  - hcl
  severity: WARNING
  metadata:
    category: security
    technology:
    - terraform
    - aws
    owasp:
    - A03:2017 - Sensitive Data Exposure
    - A04:2021 - Insecure Design
    cwe:
    - 'CWE-311: Missing Encryption of Sensitive Data'
    references:
    - https://owasp.org/Top10/A04_2021-Insecure_Design
    - https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/instance#ebs-ephemeral-and-root-block-devices
    - https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/RootDeviceStorage.html
    subcategory:
    - audit
    likelihood: LOW
    impact: HIGH
    confidence: MEDIUM
